<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <link rel="stylesheet" href="/css/style.css" />
  <script src="https://kit.fontawesome.com/b15d9bd0c0.js" crossorigin="anonymous"></script>

  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/devicon.min.css" />

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css"
    integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous" />
  <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet" />
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.24/css/jquery.dataTables.css" />
  <link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" rel="stylesheet" />
  <title>PINE STUDIOS</title>
  <link rel="icon" type="image/x-icon" href="/icon.png">
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-light">
    <h3 class="logo text-center signup" onclick="window.location='home.html';">
      PINE<span class="text-dark font-weight-bold">STUDIOS</span>
    </h3>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
      aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav mr-auto">
        <li class="nav-item">
          <a class="nav-link" href="home.html">Home </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="gallery.html">Gallery</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="services.html">Service</a>
        </li>
        <li class="nav-item active">
          <a class="nav-link font-weight-bold" href="user.html">Users<span class="sr-only">(current)</span></a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="incharge.html">In-charge</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="booking.html">Booking</a>
        </li>
      </ul>
      <button class="btn dropdown">
        <a class="nav-link dropdown-toggle text-dark" href="#" role="button" data-toggle="dropdown"
          aria-expanded="false">
          <i class="fa-solid fa-user text-dark"></i>
        </a>
        <div class="dropdown-menu">
          <a class="dropdown-item" href="profile.html">Profile</a>

          <div class="dropdown-divider"></div>
          <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logout">Logout</a>
        </div>
      </button>
    </div>
  </nav>
  <div class="gallery">
    <div class="header" data-aos="fade-left">
      <h1>USERS</h1>
      <div class="line"></div>
    </div>
    <div class="us" style="margin-top: 15px">
      <div style="overflow-x: auto">
        <table id="example" class="table table-light"></table>
      </div>
      <!-- <button class="btn btn-primary" data-target="#add" data-toggle="modal">
          Add
        </button>
        <button class="btn btn-warning" data-target="#edit" data-toggle="modal">
          Edit
        </button>
        <button
          class="btn btn-danger"
          data-target="#delete"
          data-toggle="modal"
        >
          Delete
        </button> -->
    </div>
  </div>
  <footer>
    <div class="container">
      <div class="row">
        <div class="col-md-12 text-center text-light font-weight-bold">
          FOLLOW PINE STUDIOS ON SOCIAL MEDIA
          <div class="row">
            <div class="col-md-12 d-flex socs">
              <button class="btn btn-lg">
                <i class="fa-brands fa-youtube fa-xl text-danger"></i>
              </button>
              <button class="btn btn-lg">
                <i class="fa-brands fa-square-facebook fa-xl text-primary"></i>
              </button>

              <button class="btn btn-lg">
                <span class="ig">
                  <i class="fa-brands fa-square-instagram fa-2xl"></i>
                </span>
              </button>
            </div>
            <div class="col-md-4">
              <h5>E-MAIL</h5>
              <div class="sub text-secondary text-left">
                <h6>coronpalawa@gmail.com</h6>
                <h6>municipalityofpalawan@gmail.com</h6>
                <h6>tourismpalwan@gmail.com</h6>
              </div>
            </div>
            <div class="col-md-4">
              <h5>SPONSORS</h5>
              <div class="sub text-secondary text-left">
                <h6>Marinapalawan</h6>
                <h6>Robinsonâ€™s Super Market Palawan</h6>
                <h6>Mabuhay Pilipinas inc</h6>
              </div>
            </div>
            <div class="col-md-4">
              <h5>SPECIAL THANKS</h5>
              <div class="sub text-secondary text-left">
                <h6>Jefferson Canamo Photo & Films</h6>
                <h6>Local EATS palawan</h6>
                <h6>PITIK ni Jeff</h6>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- logout-->
  <div class="modal fade" id="logout" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <h6>Are you sure you want to logout?</h6>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">
            Close
          </button>
          <button type="button" class="btn btn-danger" id="logoutBtn">Logout</button>
        </div>
      </div>
    </div>
  </div>
  <!-- ** Add-->
  <div class="modal fade" id="add" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="addUser">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Add User</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-us">
              <input type="hidden" required="" autocomplete="off" name="usertype" value="Client" />
              <div class="row">
                <div class="col-md-12">
                  <label for="profileImage">Profile Image</label>
                  <input type="file" class="form-control" name="profileImage" id="profileImage" />
                </div>
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="text" required="" autocomplete="off" name="firstname" id="firstname" />
                    <label for="firstname">Firstname</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="text" required="" autocomplete="off" name="lastname" id="lastname" />
                    <label for="lastname">Lastname</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="number" required="" autocomplete="off" name="age" id="age" />
                    <label for="age">Age</label>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="text" required="" autocomplete="off" name="email" id="email" />
                    <label for="email">Email</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="text" required="" autocomplete="off" name="address" id="address" />
                    <label for="address">Address</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="password" required="" autocomplete="off" name="password" id="password" />
                    <label for="password">Password</label>
                  </div>
                </div>
              </div>
              <h4 class="font-weight-bold mt-3">Gender</h4>
              <div class="row">
                <div class="col-md-12">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="genderMale" value="Male" />
                    <label class="form-check-label" for="genderMale">Male</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="Female" />
                    <label class="form-check-label" for="genderFemale">Female</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="genderOther"
                      value="Prefer not to say" />
                    <label class="form-check-label" for="genderOther">Prefer not to say</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              Close
            </button>
            <button type="submit" class="btn btn-primary">Add User</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- ** Edit-->
  <div class="modal fade" id="edit" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="editUser">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel">Edit User</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-us">
              <div class="row">
                <div class="col-md-12">
                  <label for="">Profile Image</label>
                  <input type="file" class="form-control" name="image" id="image" />
                </div>
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="text" required="" autocomplete="off" id="editfirstname" name="firstname" />
                    <label for="name">Firstname</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="text" required="" autocomplete="off" id="editlastname" name="lastname" />
                    <label for="name">Lastname</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="number" required="" autocomplete="off" id="editage" name="age" />
                    <label for="name">Age</label>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="text" required="" autocomplete="off" id="editemail" name="email" />
                    <label for="name">Email</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="text" required="" autocomplete="off" id="editaddress" name="address" />
                    <label for="address">Address</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="inputGroup">
                    <input type="password" required="" autocomplete="off" id="editpassword" name="password" />
                    <label for="name">Password</label>
                  </div>
                </div>
              </div>
              <h4 class="font-weight-bold mt-3">Gender</h4>
              <div class="row">
                <div class="col-md-12">
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="inlineRadio1" value="Male" />
                    <label class="form-check-label" for="inlineRadio1">
                      Male</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="inlineRadio2" value="Female" />
                    <label class="form-check-label" for="inlineRadio2">
                      Female</label>
                  </div>
                  <div class="form-check form-check-inline">
                    <input class="form-check-input" type="radio" name="gender" id="inlineRadio3"
                      value="Prefer not to say" />
                    <label class="form-check-label" for="inlineRadio3">
                      Prefer not to say</label>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              Close
            </button>
            <button type="submit" class="btn btn-primary">Update</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  <!-- ** Delete-->
  <div class="modal fade" id="delete" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <form id="deleteUser">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLabel"></h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <h6>Are you sure you want to delete this data?</h6>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">
              Close
            </button>
            <button type="submit" class="btn btn-danger">Delete</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
  <script>
    AOS.init();
  </script>
  <script src="../js/common/cookie.js"></script>
  <script src="/js/script.js"></script>
  <script src="/js/admin/main.js"></script>
  <!-- DataTables JS -->
  <script type="text/javascript" charset="utf8"
    src="https://cdn.datatables.net/1.10.24/js/jquery.dataTables.js"></script>
  <!-- * DATATABLES  -->
  <script>
    let table;
    getServiceList();

    function getServiceList() {
      table = $("#example").DataTable({
        responsive: true,
        ajax: {
          url: `${url}api/users/getAllUsers`,
          dataSrc: "data",
        },
        columns: [
          {
            data: null,
            title: "Image",
            render: function (data, type, row) {
              return `<img src="${url}/img/profiles/${row.image ? row.image : "default.png"
                }?_=${Math.floor(new Date().getTime() / 1000)}" alt="${row.name
                }" width="50" height="75" style='object-fit: cover;'/>`;
            },
          },
          {
            data: null,
            title: "Name",
            render: function (data, type, row) {
              return `
                ${row.firstname} ${row.lastname}
                `;
            },
          },
          // { data: "servicename", title: "Service Name" },
          { data: "email", title: "Email" },
          { data: "gender", title: "Gender" },
          { data: "address", title: "Address" },
          // { data: "address", title: "Address" },
          { data: "password", title: "password" },
          {
            data: null,
            title: "Action",
            className: "dt-body-right",
            render: function (data, type, row) {
              return `
                    <div class='d-flex flex-row'>
                      <button class="btn btn-warning edit_btn mr-2" data-target="#edit" 
                      data-toggle="modal"
                      data-id='${row.id}'
                      ">
                        Edit
                      </button>
                      <button
                        class="btn btn-danger trash_btn"
                        data-target="#delete"
                        data-toggle="modal"
                        data-id='${row.id}'
                      >
                        Delete
                      </button>
                    </div>
                    `;
            },
          },
        ],
      });

      $(".dataTables_filter").append(`
        <button class="btn btn-primary" data-target="#add" data-toggle="modal">
          Add
        </button>
        `);
    }
    let userid;
    // Event handler for "Edit" button click
    $("#example").on("click", ".edit_btn", function () {
      // Get the gallery id from the data-id attribute
      userid = $(this).data("id");
      console.log(userid);
      clearForm();
      let rowData = table.row($(this).closest("tr")).data();
      console.log(rowData);
      // Populate the form fields with the row data
      $("#editfirstname").val(rowData.firstname);
      $("#editlastname").val(rowData.lastname);
      $("#editage").val(rowData.age);
      $("#editemail").val(rowData.email);
      $("#editpassword").val(rowData.password);
      $("#editaddress").val(rowData.address);
      $(`input[name="gender"][value="${rowData.gender}"]`).prop(
        "checked",
        true
      );
    });
    // Handle form submission
    $("#editUser").on("submit", function (event) {
      event.preventDefault();

      const formData = new FormData(this);
      formData.append("userid", userid);
      $.ajax({
        url: `${url}api/users/updateNew`,
        type: "PUT",
        data: formData,
        contentType: false,
        processData: false,
        success: function (response) {
          if (response.error) {
            alert(response.error.email);
            $("#editemail").css("border-color", "red");
            return;
          }
          if (response.success) {
            // Refresh the DataTable to show the updated data
            table.ajax.reload(); // not working lel
            $('#edit').modal('hide')
            toastr.success("User details updated");
          } else {
            // Optionally show an error message
            alert("Failed to update users details!");
          }
        },
        error: function (jqXHR, textStatus, errorThrown) {
          // Optionally show an error message
          alert("Error: " + textStatus + " - " + errorThrown);
        },
        complete: () => {
          location.reload();
        },
      });
    });

    function clearForm() {
      // Clear text inputs
      $("#editUser input[type='text']").val("");
      $("#editUser input[type='email']").val("");
      $("#editUser input[type='password']").val("");
      // Uncheck radio buttons
      $("#editUser input[type='radio']").prop("checked", false);

      // Clear file input (profile image)
      $("#editUser input[type='file']").val("");
    }
    //** Event handler for "Trash" button click
    $("#example").on("click", ".trash_btn", function () {
      // Get the appointment id from the data-id attribute
      let userid = $(this).data("id");
      console.log(userid);

      // Handle form submission
      $("#deleteUser").on("submit", function (event) {
        event.preventDefault();

        $.ajax({
          url: `${url}api/users/delete`,
          type: "DELETE",
          data: JSON.stringify({ userid }),
          contentType: false,
          processData: false,
          success: function (response) {
            if (response.status === "success") {
              // Refresh the DataTable to show the updated data
              table.ajax.reload();
              table.ajax.reload(); // not working lel
              $('#delete').modal('hide')
              toastr.success("User Deleted!");
              // Optionally show a success message
            } else {
              // Optionally show an error message
              alert("Failed to delete user!");
            }
          },
          error: function (jqXHR, textStatus, errorThrown) {
            // Optionally show an error message
            alert("Error: " + textStatus + " - " + errorThrown);
          },
          // complete: () => {
          //   location.reload();
          // },
        });
      });
    });
  </script>
</body>

</html>